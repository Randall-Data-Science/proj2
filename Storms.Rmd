---
title: "Extreme Weather Events"
output: pdf_document
---

# Synopsis

Data from the US NOAA National Climatic Data Center 
*Storm Events Database* ^[http://www.ncdc.noaa.gov/stormevents/] include statistics 
on loss of human life and damage to property. This study will briefly explore the 
relationship between different categories of weather events and thier impact.

NOAA's National Weather Service has been collecting data on storm events since 1950.
^[http://www.ncdc.noaa.gov/stormevents/details.jsp?type=eventtype]
Over the history of the program varied and increasingly detailed information about the 
categories of weather events has been reported and compiled. In order to form a uniform 
data set of events this study uses data beginning in 1996 which follows NWS Instruction
10-1605 ^[http://www.ncdc.noaa.gov/stormevents/pd01016005curr.pdf] outlaying 48 weather
categories.

## Data Processing

The data come in a bz2-compressed csv file with all events on record from 1950 through
2011.

```{r load_libraries, message=FALSE} 
need <- function(libraries) {
  # Load libraries, installing first if necessary
  for (i in base::setdiff(libraries, .packages(all = TRUE))) {install.packages(i)} 
  for (i in base::setdiff(libraries, .packages(all = FALSE))) {
    library(package = i, character.only = TRUE)} 
}
need(c("dplyr", "lubridate", "tidyr", "ggplot2", "magrittr"))
```

```{r load_data}
if (!file.exists("data/StormData.csv.bz2")) {
  download.file(url = "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2", 
                destfile = "data/StormData.csv.bz2", method = "curl")
}

read_storm_events <- function() {
  
  
}

load_storm_data_csv_bz <- function() {
  read.csv(file = bzfile("data/StormData.csv.bz2"), header = TRUE, nrows = 10e3,
# read directly from bz2 file, wrap output dataframe in dplyr::tbl_df class                  
    colClasses = c(
      "NULL", 
      "character", #date
      rep("NULL", times = 4), #skip columns
      "factor", #state
      "factor", #type
      rep("NULL", times = 14), #skip columns
      "numeric", #fatal
      "numeric", #injuries
      "numeric", #property
      "factor", #propexp
      "numeric", #crops
      "factor", #cropsexp
      rep("NULL", times = 9))) %>% tbl_df
}

if(!exists("storm.data")) {
  if (file.exists("data/stormdata.rds")) storm.data <- readRDS(file = "data//stormdata.rds") 
    # load saved object on disk if available, otherwise:
  else {
    if (!file.exists("data/StormData.csv.bz2")) {
      download.file(destfile = "data/StormData.csv.bz2", method = "curl",
        url = "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2")}
    storm.data <- load_storm_data_csv_bz()
    saveRDS(object = storm.data, ascii = FALSE, compress = "bzip2", 
      file = "data//stormdata.rds") #cache data in only 1.2MB on disk
  }
}
```

```{r manip_data}
storm.data2 <- storm.data %>% 
  transmute(
    date = lubridate::mdy(
      x = sub(x = BGN_DATE, pattern = "([0-9/]+).*", replacement = "\\1")),
    year = year(date),
    EVTYPE, FATALITIES, INJURIES, 
    PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP
    ) %>%
  filter(year >= 1996)

storm.data2 %<>%  
  mutate(
    property = PROPDMG * 10 ^
      ifelse(test = grepl(x = PROPDMGEXP, pattern = "[0-9]"), as.numeric(PROPDMGEXP),
         ifelse(PROPDMGEXP == "h" || PROPDMGEXP == "H", 2, #hundreds
            ifelse(PROPDMGEXP == "K" || PROPDMGEXP == "k", 3, #thousands
               ifelse(PROPDMGEXP == "M" || PROPDMGEXP == "M", 6, #millions
                  ifelse(PROPDMGEXP == "B", 9, #billions
                         NA))))) #ake everything else NA
  )

storm.data2 %<>%  
  mutate(
    property = CROPDMG * 10 ^
      ifelse(test = grepl(x = CROPDMGEXP, pattern = "[0-9]"), as.numeric(CROPDMGEXP),
         ifelse(CROPDMGEXP == "h" || CROPDMGEXP == "H", 2, #hundreds
            ifelse(CROPDMGEXP == "K" || CROPDMGEXP == "k", 3, #thousands
               ifelse(CROPDMGEXP == "M" || CROPDMGEXP == "M", 6, #millions
                  ifelse(CROPDMGEXP == "B", 9, NA))))) #billions, make everything else NA
  )
```

# Overview

This analysis focuses on extreme weather events from 1996 through 2011,
corresponding with broad categories: tornadoes, hurricanes, floods, and heat.


```` {r shrink_data}
#Based on some rough exploration of only event counts:
# for (i in c("wind", "thun", "light", "floo", "torn", "heat", "hurr")) {
#   print(paste(i, length(grep(storm.data3$EVTYPE, pattern = i, ignore.case = TRUE))))}
# [1] "wind 364901"
# [1] "thun 109587"
# [1] "light 15987"
# [1] "floo 82732"
# [1] "torn 60701"
# [1] "heat 2648"
# [1] "hurr 288"

impact <- storm.data3 %>%
  filter(year >= 1993) %>%
  group_by(EVTYPE, year) %>%
  summarise(
    fatalities = sum(FATALITIES), 
    property = sum(property), 
    count = n()
    ) %>%
  mutate(
    wind = grepl(pattern = "WIND", x = EVTYPE),
    elec = grepl(pattern = "THUN|LIGHT", x = EVTYPE),
    torn = grepl(pattern = "TORN", x = EVTYPE),
    hurr = grepl(pattern = "HURR|TYPH", x = EVTYPE),
    floo = grepl(pattern = "FLOO", x = EVTYPE),
    heat = grepl(pattern = "HEAT", x = EVTYPE)
)

impact.all <- rbind(
  impact %>%
    filter(torn) %>%
    group_by(year) %>%
    summarise(fatalities = sum(fatalities), 
              property = sum(property)) %>%
    mutate(type = "Tornadoes")
  ,
  impact %>%
    filter(wind) %>%
    group_by(year) %>%
    summarise(fatalities = sum(fatalities), 
              property = sum(property)) %>%
    mutate(type = "Wind Storms")
  ,
  impact %>%
    filter(elec) %>%
    group_by(year) %>%
    summarise(fatalities = sum(fatalities), 
              property = sum(property)) %>%
    mutate(type = "Electrical Storms")
  ,
  impact %>%
    filter(hurr) %>%
    group_by(year) %>%
    summarise(fatalities = sum(fatalities), 
              property = sum(property)) %>%
    mutate(type = "Hurricanes")
  ,
  impact %>%
    filter(floo) %>%
    group_by(year) %>%
    summarise(fatalities = sum(fatalities), 
              property = sum(property)) %>%
    mutate(type = "Floods")
  ,
  impact %>%
    filter(heat) %>%
    group_by(year) %>%
    summarise(fatalities = sum(fatalities), 
              property = sum(property)) %>%
    mutate(type = "Heat")
  )
```

### According to the reported data, how the cost to human life of the different 
types of storms compare:

```{r}
ggplot(data = impact.all) + 
  aes(x = year, y = fatalities) + 
  geom_point(mapping = aes(group = type, color = type)) + 
  geom_line(aes(color = type))
```

### According to the reported data, how the property damage of the different 
types of storms compare:

```{r}
ggplot(data = impact.all) + 
  aes(x = year, y = property) + 
  geom_point(mapping = aes(group = type, color = type)) + 
  geom_line(aes(color = type))
```

## Conclusion

According to the data hurricanes tend to result in fewer deaths than the other
three types. Despite their prominence in the news they are rarer events than
fatal heat waves, or deaths from flooding and tornadoes.

While heat events are notable for the number of deaths, they result in little 
property damage. However, floods cause significant property damage, as do tornadoes.